# IBDスクリーナー データ欠損の原因分析レポート

## 実行日: 2025-11-14

---

## 1. 概要

run_ibd_screeners.pyの実行結果で以下のデータ欠損が発生：

| 項目 | 対象銘柄数 | 取得/計算数 | 欠損数 | 欠損率 |
|------|-----------|------------|--------|--------|
| ティッカー総数 | 5,651 | - | - | - |
| データ収集成功 | 5,651 | 4,993 | 658 | 11.6% |
| 年間成長率 | 4,993 | 2,239 | 2,754 | 55.2% |
| 安定性スコア | 4,993 | 2,439 | 2,554 | 51.2% |

---

## 2. 原因の詳細分析

### 2.1. 658銘柄のデータ収集失敗（11.6%）

**コード箇所**: `ibd_data_collector.py:121-178`

#### 失敗理由

1. **株価データ不足**（条件: 252営業日以上必要）
   - 新規上場企業（IPO後1年未満）
   - 取引が薄い銘柄
   - OTC市場の小型株

2. **四半期損益計算書不足**（条件: 5期以上必要）
   - 新規上場企業
   - 財務報告が不定期な企業
   - FMP APIでデータが利用できない銘柄

3. **APIリクエストエラー**
   - タイムアウト
   - HTTP 404エラー（銘柄が見つからない）
   - レート制限超過（ただし750 calls/minで緩和済み）

#### Web検索から判明した事実

- FMP APIは80,000以上の銘柄をカバーしているが、すべてに完全な財務データがあるわけではない
- 特にOTC銘柄やマイクロキャップ株ではデータが不完全
- 地域によって報告頻度が異なる（例: インドのBSE/NSEは半期・年次報告）

---

### 2.2. 年間成長率が2,239銘柄しか計算できない（55.2%欠損）

**コード箇所**: `ibd_data_collector.py:377-389`

#### 計算条件（非常に厳しい）

```python
# 年次損益計算書が3期以上必要（3年CAGR計算のため）
if income_statements_annual and len(income_statements_annual) >= 3:
    eps_values = [stmt.get('eps', 0) for stmt in income_statements_annual[:3]]
    # 全期間でEPSが正の値である必要がある
    if eps_values[0] and eps_values[0] > 0 and eps_values[-1] and eps_values[-1] > 0:
        years = len(eps_values) - 1
        cagr = (pow(eps_values[0] / eps_values[-1], 1/years) - 1) * 100
        annual_growth_rate = cagr
```

#### 条件を満たせない銘柄（推定内訳）

1. **新規上場企業**: 上場後3年未満の企業
   - 2022年以降のIPO: 推定500-1,000銘柄

2. **赤字企業**: EPSが負またはゼロ
   - スタートアップ、バイオテック企業
   - 業績悪化企業
   - 推定1,500-2,000銘柄

3. **年次データが不完全**: FMP APIで3期分の年次データが取得できない
   - 外国企業（ADR）
   - 報告頻度が低い企業
   - 推定500-800銘柄

#### 対策案

- 条件を緩和（2年CAGRで計算、またはEPSが1期だけ赤字でも許容）
- 年次データがない場合、四半期データから年換算
- 赤字企業は年間成長率をN/Aとして別途扱う

---

### 2.3. 安定性スコアが2,439銘柄しか計算できない（51.2%欠損）

**コード箇所**: `ibd_data_collector.py:392-410`

#### 計算条件

```python
# 四半期損益計算書が8期必要
if len(income_statements_quarterly) >= 8:
    eps_last_8q = [stmt.get('eps', 0) for stmt in income_statements_quarterly[:8]]
    # その中で少なくとも6期のEPSが正の値である必要がある
    eps_last_8q = [e for e in eps_last_8q if e is not None and e > 0]

    if len(eps_last_8q) >= 6:
        # 変動係数を計算...
```

#### 条件を満たせない銘柄（推定内訳）

1. **新規上場企業**: 上場後2年未満の企業
   - 推定800-1,200銘柄

2. **変動の激しい企業**: 8期中3期以上赤字
   - 景気敏感株
   - バイオテック企業（治験結果で大幅変動）
   - 推定1,000-1,500銘柄

3. **四半期データが不完全**:
   - 外国企業（四半期報告がない国もある）
   - 推定300-500銘柄

#### 対策案

- 条件を緩和（6期データ、4期以上正EPSで計算）
- 赤字期を含む変動係数を計算する別指標を追加
- 新規上場企業用の簡易安定性スコア（利用可能データから計算）

---

## 3. FMP API固有の問題（Web検索結果）

### 3.1. データ品質の課題

- **ユーザー報告**: 2024-2025年にデータ不正確性の報告が増加
  - 収益データの誤り（例: Alcoa Corp (AA) のQ3 2024収益が負値）
  - 銘柄数の水増し（廃止銘柄を含む）

- **カバレッジの限界**:
  - すべての企業が四半期ごとに完全な財務データを報告するわけではない
  - バランスシートは半期報告、キャッシュフローは年次報告のみの企業もある

### 3.2. 報告頻度の地域差

- **米国**: 四半期報告が標準（10-Q、10-K）
- **ヨーロッパ**: 半期報告が一般的
- **インド**: BSE/NSEは損益計算書のみ四半期、バランスシートは半期
- **その他**: 年次報告のみの市場もある

---

## 4. 実装した改善策

### 4.1. 詳細なエラーログ機能

**変更ファイル**: `ibd_data_collector.py`

#### 追加機能

1. **エラーログ記録**
   ```python
   def log_error(self, ticker: str, error_type: str, error_detail: str, api_endpoint: str = None)
   ```

2. **エラータイプ分類**
   - `DATA_INSUFFICIENT`: データ不足（株価、四半期財務）
   - `DATA_WARNING`: オプショナルデータの欠損（年次財務、プロファイル）
   - `EPS_CALC_FAILED`: EPS計算失敗
   - `EPS_ANNUAL_GROWTH_MISSING`: 年間成長率計算不可
   - `EPS_STABILITY_MISSING`: 安定性スコア計算不可
   - `EXCEPTION`: 予期しないエラー

3. **CSVエクスポート機能**
   ```python
   def save_error_logs(self, filename: str = 'ibd_data_collection_errors.csv')
   ```

   出力内容:
   - timestamp: エラー発生時刻
   - ticker: 銘柄シンボル
   - error_type: エラータイプ
   - error_detail: 詳細説明
   - api_endpoint: 失敗したAPIエンドポイント

4. **エラー集計レポート**
   - エラータイプ別の件数集計
   - コンソールに表示

#### 使用方法

```bash
python run_ibd_screeners.py
```

実行後、`ibd_data_collection_errors.csv`が自動生成され、すべてのエラーが記録されます。

---

## 5. 推奨される次のステップ

### 5.1. 短期的対策（すぐに実装可能）

1. **エラーログの分析**
   ```bash
   # CSVファイルを開いて、最も多いエラータイプを確認
   # エラータイプ別に銘柄リストを作成
   ```

2. **条件の緩和検討**
   - 年間成長率: 2年CAGRを許容、または四半期データから年換算
   - 安定性スコア: 6期データで計算（現在8期）

3. **データ品質チェック**
   - エラーログから特定の銘柄のAPIレスポンスを手動確認
   - FMP APIのドキュメントで該当銘柄のデータ可用性を確認

### 5.2. 中期的改善（1-2週間）

1. **代替データソース**
   - Alpha Vantage、Yahoo Finance、Polygonなどの併用
   - FMP APIで取得できないデータを他のソースで補完

2. **赤字企業の扱い**
   - 赤字企業専用の成長指標（売上成長率、キャッシュフロー成長率）
   - EPSが負の場合の特別処理

3. **新規上場企業の扱い**
   - データ期間が短い企業用の簡易指標
   - 「データ不足」フラグを付けてスクリーナーで除外可能に

### 5.3. 長期的改善（1ヶ月以上）

1. **データキャッシング戦略**
   - 一度取得したデータを長期保存
   - 差分更新で効率化

2. **機械学習による欠損値補完**
   - 類似企業のデータから推定
   - 業界平均での補完

3. **カスタムデータパイプライン**
   - SEC EDGARから直接データ取得（米国企業）
   - 各国の金融当局APIの利用

---

## 6. まとめ

### データ欠損の主要因

1. **新規上場企業**: 履歴データ不足（推定1,000-1,500銘柄）
2. **赤字企業**: EPS条件を満たせない（推定1,500-2,000銘柄）
3. **FMP APIのカバレッジ限界**: データが不完全または利用不可（推定500-1,000銘柄）

### 実装した改善策

- 詳細なエラーログ機能（CSV出力、エラータイプ分類）
- エラー集計レポート

### 今後の対応

1. エラーログを分析して、具体的な銘柄とエラー原因を特定
2. 計算条件の緩和を検討（特に年間成長率と安定性スコア）
3. 代替データソースの検討

---

## 7. 参考情報

### エラーログの確認方法

```bash
# エラーログを表示
cat ibd_data_collection_errors.csv

# エラータイプ別に集計
cut -d',' -f3 ibd_data_collection_errors.csv | sort | uniq -c | sort -rn

# 特定の銘柄のエラーを確認
grep "AAPL" ibd_data_collection_errors.csv
```

### コード変更箇所

- `ibd_data_collector.py:37`: エラーログリストを初期化
- `ibd_data_collector.py:110-119`: log_errorメソッドを追加
- `ibd_data_collector.py:121-178`: collect_ticker_dataでエラーログ記録
- `ibd_data_collector.py:319-370`: calculate_and_store_eps_componentsでEPSエラーログ記録
- `ibd_data_collector.py:256-283`: save_error_logsメソッドを追加
- `ibd_data_collector.py:582`: run_full_collectionでエラーログ保存

---

**調査実施者**: Claude Code
**調査日**: 2025-11-14
**対象コード**: MarketAlgo/ibd_data_collector.py, ibd_ratings_calculator.py
